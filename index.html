<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Spotify Wrapped – By Cxrgi</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #000;
      color: #fff;
      text-align: center;
    }
    #login-section {
      margin-top: 80px;
    }
    button {
      background: #1db954;
      border: none;
      padding: 14px 26px;
      color: white;
      border-radius: 40px;
      font-size: 18px;
      cursor: pointer;
    }
    button:hover {
      opacity: 0.85;
    }
    #loader {
      margin-top: 50px;
      font-size: 22px;
      display: none;
    }
    .hidden {
      display: none;
    }
    .card {
      background: #111;
      padding: 20px;
      margin: 20px auto;
      border-radius: 20px;
      width: 90%;
      max-width: 500px;
    }
  </style>
</head>

<body>

  <div id="login-section">
    <h1>Spotify Wrapped</h1>
    <p>Analyse dein Jahr auf Spotify</p>
    <button onclick="loginPKCE()">Mit Spotify verbinden</button>
  </div>

  <div id="loader">Daten werden geladen...</div>

  <div id="dashboard" class="hidden">
    <h2>Dein Wrapped</h2>
    <div id="content"></div>
    <button onclick="logout()">Logout</button>
  </div>

<script>
  /* -----------------------------------------------------
     CONFIG
  ----------------------------------------------------- */

  const CLIENT_ID = "16bc9b25c0ce4df8b139406e36a97b0d";
  const REDIRECT_URI = "https://cxrgi.github.io/SpotifyWrapped/";
  const SCOPES = [
    "user-top-read",
    "user-read-recently-played",
    "user-read-currently-playing",
    "user-read-private"
  ];

  // ❗ HIER deine Vercel-URL eintragen
  const SERVERLESS_TOKEN_ENDPOINT =
    "https://spotify-wrapped-eight.vercel.app/api/exchange";


  /* -----------------------------------------------------
     HELPER – PKCE
  ----------------------------------------------------- */

  async function sha256(str) {
    const buffer = new TextEncoder().encode(str);
    const hash = await crypto.subtle.digest("SHA-256", buffer);
    return new Uint8Array(hash);
  }
  function base64url(bytes) {
    return btoa(String.fromCharCode(...bytes))
      .replace(/\+/g, "-")
      .replace(/\//g, "_")
      .replace(/=+$/, "");
  }

  async function generateCodeChallenge(verifier) {
    const hash = await sha256(verifier);
    return base64url(hash);
  }


  /* -----------------------------------------------------
     LOGIN FLOW
  ----------------------------------------------------- */

  async function loginPKCE() {
    // generate code_verifier
    const verifier = base64url(crypto.getRandomValues(new Uint8Array(64)));
    localStorage.setItem("spotify_code_verifier", verifier);

    const challenge = await generateCodeChallenge(verifier);

    const params = new URLSearchParams({
      client_id: CLIENT_ID,
      response_type: "code",
      redirect_uri: REDIRECT_URI,
      code_challenge_method: "S256",
      code_challenge: challenge,
      scope: SCOPES.join(" ")
    });

    window.location.href = "https://accounts.spotify.com/authorize?" + params.toString();
  }


  /* -----------------------------------------------------
     TOKEN HANDLING (mit Refresh Fix)
  ----------------------------------------------------- */

  async function exchangeCodeForToken(code) {
    const verifier = localStorage.getItem("spotify_code_verifier");

    const res = await fetch(SERVERLESS_TOKEN_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        code,
        redirect_uri: REDIRECT_URI,
        code_verifier: verifier
      })
    });

    const data = await res.json();
    if (!res.ok) throw new Error("Token exchange error: " + JSON.stringify(data));

    storeTokenData(data);
  }

  function storeTokenData(data) {
    localStorage.setItem("spotify_token", data.access_token);
    localStorage.setItem("spotify_refresh_token", data.refresh_token || "");
    localStorage.setItem("spotify_token_timestamp", Date.now());
  }

  async function refreshToken() {
    const refresh = localStorage.getItem("spotify_refresh_token");
    if (!refresh) throw new Error("No refresh token");

    const res = await fetch(SERVERLESS_TOKEN_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ refresh_token: refresh })
    });

    const json = await res.json();
    if (!res.ok) throw new Error("Refresh error: " + JSON.stringify(json));

    storeTokenData(json);
    return json.access_token;
  }


  /* -----------------------------------------------------
     API FETCH HELPERS – FIXED
  ----------------------------------------------------- */

  async function fetchWebApi(endpoint, token) {
    const res = await fetch("https://api.spotify.com/v1/" + endpoint, {
      headers: { Authorization: "Bearer " + token }
    });

    if (!res.ok) {
      const body = await res.text();
      const err = new Error("API Error " + res.status);
      err.status = res.status;
      err.body = body;
      throw err;
    }

    return res.json();
  }


  /* -----------------------------------------------------
     DATEN LADEN – MIT ENDLOSSCHLEIFEN FIX
  ----------------------------------------------------- */

  let refreshOnce = false;

  async function loadData() {
    let token = localStorage.getItem("spotify_token");
    if (!token) return;

    document.getElementById("login-section").classList.add("hidden");
    document.getElementById("loader").style.display = "block";

    try {
      const user = await fetchWebApi("me", token);
      const artists = await fetchWebApi("me/top/artists?time_range=medium_term&limit=10", token);
      const tracks = await fetchWebApi("me/top/tracks?time_range=medium_term&limit=20", token);

      const ids = tracks.items.map(t => t.id).join(",");
      let audio = { audio_features: [] };
      if (ids) audio = await fetchWebApi("audio-features?ids=" + ids, token);

      renderDashboard({ user, artists, tracks, audio });

    } catch (err) {
      console.warn("loadData err:", err);

      if ((err.status === 401 || err.status === 403) && !refreshOnce) {
        refreshOnce = true;
        try {
          const newToken = await refreshToken();
          return loadData();
        } catch (e) {
          console.error("Refresh failed:", e);
          return logout();
        }
      }

      alert("Fehler bei der Verbindung. Bitte neu einloggen.");
      logout();
    }
  }


  /* -----------------------------------------------------
     UI RENDERING
  ----------------------------------------------------- */

  function renderDashboard(data) {
    document.getElementById("loader").style.display = "none";

    const dash = document.getElementById("dashboard");
    dash.classList.remove("hidden");

    const c = document.getElementById("content");
    c.innerHTML = `
      <div class="card">
        <h2>Hallo ${data.user.display_name}</h2>
        <p>Das ist dein Wrapped.</p>
      </div>

      <div class="card">
        <h3>Top Künstler</h3>
        <ul style="list-style:none;padding:0;">
          ${data.artists.items.map(a => `<li>${a.name}</li>`).join("")}
        </ul>
      </div>

      <div class="card">
        <h3>Top Songs</h3>
        <ul style="list-style:none;padding:0;">
          ${data.tracks.items.map(t => `<li>${t.name}</li>`).join("")}
        </ul>
      </div>
    `;
  }


  /* -----------------------------------------------------
     LOGOUT
  ----------------------------------------------------- */

  function logout() {
    localStorage.removeItem("spotify_token");
    localStorage.removeItem("spotify_refresh_token");
    localStorage.removeItem("spotify_code_verifier");
    location.href = REDIRECT_URI;
  }


  /* -----------------------------------------------------
     REDIRECT CALLBACK
  ----------------------------------------------------- */

  async function handleRedirect() {
    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");

    if (code) {
      await exchangeCodeForToken(code);
      window.history.replaceState({}, document.title, REDIRECT_URI);
      loadData();
      return;
    }

    if (localStorage.getItem("spotify_token")) {
      loadData();
    }
  }

  handleRedirect();
</script>

</body>
</html>
