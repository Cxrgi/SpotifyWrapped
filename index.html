<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Spotify Wrapped</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --spotify-black: #121212;
            --spotify-dark-gray: #181818;
            --spotify-light-gray: #282828;
            --spotify-green: #1DB954;
            --spotify-white: #FFFFFF;
            --card-radius: 25px;
            --font-family: 'Circular Std', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }

        body {
            background-color: var(--spotify-black);
            color: var(--spotify-white);
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* --- Utility & Animations --- */
        .hidden { display: none !important; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.8s ease-out forwards;
        }

        /* --- Login Screen --- */
        #login-section {
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        h1 { font-size: 3rem; margin-bottom: 1rem; }
        
        .btn-spotify {
            background-color: var(--spotify-green);
            color: white;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: bold;
            text-decoration: none;
            border: none;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
            box-shadow: 0 4px 15px rgba(29, 185, 84, 0.4);
        }

        .btn-spotify:hover {
            transform: scale(1.05);
            background-color: #1ed760;
        }

        /* --- Loader --- */
        #loader {
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--spotify-light-gray);
            border-top: 5px solid var(--spotify-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Dashboard Grid --- */
        #dashboard {
            width: 100%;
            max-width: 1200px;
            padding: 40px 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .header-bar {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card {
            background-color: var(--spotify-dark-gray);
            border-radius: var(--card-radius);
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .card:hover {
            transform: translateY(-5px);
            background-color: var(--spotify-light-gray);
        }

        .card-title {
            color: #b3b3b3;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
        }

        .card-content h2 {
            font-size: 2rem;
            margin: 0;
            line-height: 1.2;
        }

        .card-content h3 {
            font-size: 1.2rem;
            color: var(--spotify-green);
            margin: 5px 0 0 0;
        }

        /* Specific Layouts */
        .card.large { grid-row: span 2; }
        .card.wide { grid-column: span 2; }

        .list-item {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            border-bottom: 1px solid #333;
            padding-bottom: 8px;
        }
        .list-item:last-child { border-bottom: none; }
        
        .rank {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--spotify-green);
            margin-right: 15px;
            width: 20px;
        }

        .item-img {
            width: 50px;
            height: 50px;
            border-radius: 5px;
            margin-right: 15px;
            object-fit: cover;
        }

        .item-info { display: flex; flex-direction: column; }
        .item-name { font-weight: bold; font-size: 1rem; }
        .item-sub { color: #b3b3b3; font-size: 0.85rem; }

        /* Now Playing Widget */
        .now-playing {
            border: 1px solid var(--spotify-green);
            background: linear-gradient(135deg, var(--spotify-dark-gray) 0%, #0d2e1a 100%);
        }
        .animate-pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(29, 185, 84, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(29, 185, 84, 0); }
            100% { box-shadow: 0 0 0 0 rgba(29, 185, 84, 0); }
        }

        /* Buttons */
        .action-btn {
            background: transparent;
            border: 1px solid var(--spotify-white);
            color: var(--spotify-white);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            margin-left: 10px;
        }
        .action-btn:hover { background: rgba(255,255,255,0.1); }

        /* Responsive Fix for Wide cards */
        @media (max-width: 768px) {
            .card.wide { grid-column: span 1; }
        }
    </style>
</head>
<body>

    <section id="login-section">
        <h1>Dein JahresrÃ¼ckblick</h1>
        <p style="color: #b3b3b3; margin-bottom: 2rem;">Logge dich ein, um deine Spotify Statistiken zu sehen.</p>
        <button id="login-btn" class="btn-spotify">Mit Spotify verbinden</button>
    </section>

    <section id="loader" class="hidden">
        <div class="spinner"></div>
        <p style="margin-left: 15px;">Daten werden analysiert...</p>
    </section>

    <section id="dashboard" class="hidden">
        <div class="header-bar fade-in">
            <h2>Hallo, <span id="user-name">Nutzer</span></h2>
            <div>
                <button class="action-btn" onclick="exportData()">JSON Export</button>
                <button class="action-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="card now-playing fade-in" id="now-playing-card" style="display:none;">
            <div class="card-title">Currently Playing <span style="float:right;">ðŸ”´ Live</span></div>
            <div class="list-item" style="border:none;">
                <img id="np-img" class="item-img" src="" alt="">
                <div class="item-info">
                    <span id="np-name" class="item-name">Song Name</span>
                    <span id="np-artist" class="item-sub">Artist</span>
                </div>
            </div>
        </div>

        <div class="card large fade-in">
            <div class="card-title">Top Artist des Jahres</div>
            <div style="flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;">
                <img id="top-artist-img" src="" style="width: 150px; height: 150px; border-radius: 50%; box-shadow: 0 8px 24px rgba(0,0,0,0.5); margin-bottom: 20px;" alt="Top Artist">
                <h2 id="top-artist-name">Artist Name</h2>
                <h3 id="top-artist-genre">Genre</h3>
            </div>
        </div>

        <div class="card fade-in">
            <div class="card-title">Deine Top Artists</div>
            <div id="top-artists-list"></div>
        </div>

        <div class="card fade-in">
            <div class="card-title">Top Song des Jahres</div>
            <div style="display: flex; align-items: center; margin-top: 10px;">
                <img id="top-song-img" src="" class="item-img" style="width: 80px; height: 80px;" alt="Cover">
                <div>
                    <h2 id="top-song-name" style="font-size: 1.5rem;">Song Title</h2>
                    <h3 id="top-song-artist" style="font-size: 1rem; color: #b3b3b3;">Artist</h3>
                </div>
            </div>
        </div>

        <div class="card fade-in">
            <div class="card-title">Genre Breakdown</div>
            <canvas id="genreChart"></canvas>
        </div>

        <div class="card wide fade-in">
            <div class="card-title">Deine Top 10 Songs</div>
            <div id="top-songs-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px;"></div>
        </div>

        <div class="card fade-in">
            <div class="card-title">Dein Audio Profil</div>
            <canvas id="audioChart"></canvas>
        </div>
    </section>

    <script>
        // --- KONFIGURATION ---
        // ERSETZE DIESE WERTE MIT DEINEN DATEN AUS DEM SPOTIFY DASHBOARD
        const CLIENT_ID = '16bc9b25c0ce4df8b139406e36a97b0d'; 
        const REDIRECT_URI = 'https://cxrgi.github.io/SpotifyWrapped/';
        
        const SCOPES = [
            'user-top-read',
            'user-read-recently-played',
            'user-read-currently-playing',
            'user-read-private'
        ];

        // --- GLOBAL STATE ---
        let allData = {};

        // --- AUTH LOGIC ---
        function getAccessTokenFromUrl() {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            return params.get('access_token');
        }

        function login() {
            const authUrl = `accounts.spotify.com{CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(SCOPES.join(' '))}&response_type=token&show_dialog=true`;
            window.location.href = authUrl;
        }

        function logout() {
            localStorage.removeItem('spotify_token');
            localStorage.removeItem('spotify_token_timestamp');
            localStorage.removeItem('spotify_data_cache');
            window.location.hash = '';
            location.reload();
        }

        // --- API FETCHING ---
        async function fetchWebApi(endpoint, token) {
            const res = await fetch(`api.spotify.com{endpoint}`, {
                headers: { Authorization: `Bearer ${token}` },
            });
            if (!res.ok) throw new Error(`API Error: ${res.status}`);
            return res.json();
        }

        async function loadData() {
            const token = localStorage.getItem('spotify_token');
            if (!token) return;

            // Check Cache
            const cached = localStorage.getItem('spotify_data_cache');
            if (cached) {
                console.log("Loading from cache");
                renderDashboard(JSON.parse(cached));
                return;
            }

            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('loader').classList.remove('hidden');

            try {
                // Parallele Requests fÃ¼r Speed
                const [user, artists, tracks, playing] = await Promise.all([
                    fetchWebApi('me', token),
                    fetchWebApi('me/top/artists?time_range=medium_term&limit=10', token), // medium_term = ca. 6 Monate (gut fÃ¼r JahresrÃ¼ckblick)
                    fetchWebApi('me/top/tracks?time_range=medium_term&limit=20', token),
                    fetchWebApi('me/player/currently-playing', token).catch(() => null) // Catch error if nothing playing
                ]);

                // Audio Features fÃ¼r die Top Tracks holen
                const trackIds = tracks.items.map(t => t.id).join(',');
                const audioFeatures = await fetchWebApi(`audio-features?ids=${trackIds}`, token);

                allData = { user, artists, tracks, audioFeatures, playing };
                
                // Cache speichern
                localStorage.setItem('spotify_data_cache', JSON.stringify(allData));
                
                renderDashboard(allData);

            } catch (e) {
                console.error(e);
                alert("Session abgelaufen oder Fehler beim Laden. Bitte neu einloggen.");
                logout();
            }
        }

        // --- RENDERING ---
        function renderDashboard(data) {
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');

            // 1. User Info
            document.getElementById('user-name').innerText = data.user.display_name;

            // 2. Top Artist Hero
            const topArtist = data.artists.items[0];
            if (topArtist) {
                document.getElementById('top-artist-name').innerText = topArtist.name;
                document.getElementById('top-artist-img').src = topArtist.images[0].url;
                document.getElementById('top-artist-genre').innerText = topArtist.genres[0] || 'Pop';
            }

            // 3. Top 5 Artists List
            const artistList = document.getElementById('top-artists-list');
            data.artists.items.slice(0, 5).forEach((artist, index) => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <span class="rank">${index + 1}</span>
                    <img class="item-img" src="${artist.images[2]?.url || artist.images[0].url}">
                    <div class="item-info">
                        <span class="item-name">${artist.name}</span>
                    </div>
                `;
                artistList.appendChild(div);
            });

            // 4. Top Song Hero
            const topSong = data.tracks.items[0];
            if (topSong) {
                document.getElementById('top-song-name').innerText = topSong.name;
                document.getElementById('top-song-artist').innerText = topSong.artists.map(a => a.name).join(', ');
                document.getElementById('top-song-img').src = topSong.album.images[0].url;
            }

            // 5. Top 10 Songs Grid
            const songsList = document.getElementById('top-songs-list');
            data.tracks.items.slice(0, 10).forEach((track, index) => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <span class="rank">${index + 1}</span>
                    <img class="item-img" src="${track.album.images[2]?.url || track.album.images[0].url}">
                    <div class="item-info">
                        <span class="item-name">${track.name}</span>
                        <span class="item-sub">${track.artists[0].name}</span>
                    </div>
                `;
                songsList.appendChild(div);
            });

            // 6. Currently Playing
            if (data.playing && data.playing.item) {
                const np = document.getElementById('now-playing-card');
                np.style.display = 'flex';
                np.classList.add('animate-pulse');
                document.getElementById('np-name').innerText = data.playing.item.name;
                document.getElementById('np-artist').innerText = data.playing.item.artists.map(a => a.name).join(', ');
                document.getElementById('np-img').src = data.playing.item.album.images[0].url;
            }

            // 7. Genre Chart Logic
            const genreCounts = {};
            data.artists.items.forEach(artist => {
                artist.genres.forEach(genre => {
                    genreCounts[genre] = (genreCounts[genre] || 0) + 1;
                });
            });
            // Sort & Top 5 Genres
            const sortedGenres = Object.entries(genreCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            renderGenreChart(sortedGenres);

            // 8. Audio Profile Logic
            const features = data.audioFeatures.audio_features;
            if(features) {
                const avg = (key) => features.reduce((sum, f) => sum + (f ? f[key] : 0), 0) / features.length;
                renderAudioChart([avg('danceability'), avg('energy'), avg('valence'), avg('acousticness')]);
            }
        }

        function renderGenreChart(genres) {
            const ctx = document.getElementById('genreChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: genres.map(g => g[0]),
                    datasets: [{
                        data: genres.map(g => g[1]),
                        backgroundColor: ['#1DB954', '#1ed760', '#ffffff', '#b3b3b3', '#535353'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'right', labels: { color: 'white' } } }
                }
            });
        }

        function renderAudioChart(dataPoints) {
            const ctx = document.getElementById('audioChart').getContext('2d');
            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Danceability', 'Energy', 'Positivity (Valence)', 'Acousticness'],
                    datasets: [{
                        label: 'Dein Vibe',
                        data: dataPoints,
                        backgroundColor: 'rgba(29, 185, 84, 0.5)',
                        borderColor: '#1DB954',
                        pointBackgroundColor: '#fff'
                    }]
                },
                options: {
                    scales: {
                        r: {
                            grid: { color: '#333' },
                            angleLines: { color: '#333' },
                            suggestedMin: 0,
                            suggestedMax: 1,
                            ticks: { display: false }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- EXPORT ---
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "spotify_wrapped_data.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        // --- INIT ---
        document.getElementById('login-btn').addEventListener('click', login);

        const urlToken = getAccessTokenFromUrl();
        if (urlToken) {
            window.location.hash = ''; // Token aus URL entfernen
            localStorage.setItem('spotify_token', urlToken);
            loadData();
        } else if (localStorage.getItem('spotify_token')) {
            loadData();
        }
    </script>
</body>
</html>